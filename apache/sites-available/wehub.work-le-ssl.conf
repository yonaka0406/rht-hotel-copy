<VirtualHost *:443>
    ServerName wehub.work
    ServerAlias www.wehub.work
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/wehub.work/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/wehub.work/privkey.pem

    DocumentRoot /var/www/wehub.work/dist/

    <Directory /var/www/wehub.work/dist/>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # Reverse Proxy for API Requests
    ProxyPass "/api" "http://127.0.0.1:5000/api"
    ProxyPassReverse "/api" "http://127.0.0.1:5000/api"

    # Reverse Proxy for WebSockets (socket.io)
    ProxyPass "/socket.io/" "ws://127.0.0.1:5000/socket.io/"
    ProxyPassReverse "/socket.io/" "ws://127.0.0.1:5000/socket.io/"

    <Location "/socket.io/">
        ProxyPreserveHost On
        ProxyPassReverse /
        ProxyPassReverseCookieDomain localhost wehub.work
        Header set Access-Control-Allow-Origin "*"
        RequestHeader set X-Forwarded-Proto "https"
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule .* "ws://127.0.0.1:5000%{REQUEST_URI}" [P]
    </Location>

    # Vue Router SPA Handling
    RewriteEngine On
    RewriteRule ^index\.html$ - [L]
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteCond %{REQUEST_URI} !^/socket.io/
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule !\.(js|css|png|jpg|gif|svg|webp|ico|woff2|woff|ttf)$ /index.html [L]

    ErrorLog ${APACHE_LOG_DIR}/wehub.work_error.log
    CustomLog ${APACHE_LOG_DIR}/wehub.work_access.log combined
</VirtualHost>
