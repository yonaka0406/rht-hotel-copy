<VirtualHost *:80>
    ServerName test.wehub.work
    Redirect permanent / https://test.wehub.work/
</VirtualHost>

<IfModule mod_ssl.c>
<VirtualHost *:443>
    ServerName test.wehub.work
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/test.wehub.work/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/test.wehub.work/privkey.pem
    Include /etc/letsencrypt/options-ssl-apache.conf

    DocumentRoot /var/www/test.wehub.work/dist/

    <Directory /var/www/test.wehub.work/dist/>
	Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted
    </Directory>

    # Reverse Proxy for API Requests
    ProxyPreserveHost On
    RequestHeader set X-Forwarded-Proto "https"

    # CORS HEADERS FOR ALL API REQUESTS
    Header set Access-Control-Allow-Origin "https://test.wehub.work"
    Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Request-Environment"
    Header set Access-Control-Allow-Credentials "true"
    Header always set Access-Control-Max-Age "86400"

    # Handle OPTIONS preflight requests
    RewriteEngine On
    RewriteCond %{REQUEST_METHOD} OPTIONS
    RewriteRule ^(.*)$ - [L,R=200,NS]

    ProxyPass /api http://127.0.0.1:3001/api
    ProxyPassReverse /api http://127.0.0.1:3001/api

    # Reverse Proxy for WebSockets (socket.io)
    ProxyPass "/socket.io/" "ws://127.0.0.1:3001/socket.io/"
    ProxyPassReverse "/socket.io/" "ws://127.0.0.1:3001/socket.io/"

    <Location "/socket.io/">
        ProxyPreserveHost On
        ProxyPassReverse /
        ProxyPassReverseCookieDomain localhost wehub.work
        Header set Access-Control-Allow-Origin "https://test.wehub.work"
        Header set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
        Header set Access-Control-Allow-Headers "Content-Type, Authorization, X-Request-Environment"
        Header set Access-Control-Allow-Credentials "true"
        RequestHeader set X-Forwarded-Proto "https"
        RewriteEngine On
        RewriteCond %{HTTP:Upgrade} websocket [NC]
        RewriteCond %{HTTP:Connection} upgrade [NC]
        RewriteRule .* "ws://127.0.0.1:3001%{REQUEST_URI}" [P]
    </Location>

    # Vue Router SPA Handling
    RewriteEngine On
    RewriteRule ^index\.html$ - [L]
    RewriteCond %{REQUEST_URI} !^/api/
    RewriteCond %{REQUEST_URI} !^/socket.io/
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteRule !\.(js|css|png|jpg|gif|svg|webp|ico|woff2|woff|ttf)$ /index.html [L]

    ErrorLog ${APACHE_LOG_DIR}/test.wehub.work_error.log
    CustomLog ${APACHE_LOG_DIR}/test.wehub.work_access.log combined

</VirtualHost>
</IfModule>
