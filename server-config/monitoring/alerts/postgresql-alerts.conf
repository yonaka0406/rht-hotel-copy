# PostgreSQL Monitoring and Alerting Configuration

# Email notification settings
ALERT_EMAIL="admin@example.com"
ALERT_FROM="postgres-monitor@example.com"
SMTP_SERVER="smtp.example.com"
SMTP_PORT="587"
SMTP_USER="alerts@example.com"
SMTP_PASSWORD="your_smtp_password"

# Slack webhook notification settings (optional)
SLACK_WEBHOOK_URL="https://hooks.slack.com/services/TXXXXXXXX/BXXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXX"
SLACK_CHANNEL="#database-alerts"

# Monitoring thresholds
MAX_CPU_USAGE=90
MAX_MEMORY_USAGE=90
MAX_DISK_USAGE=85
MAX_CONNECTION_PERCENTAGE=80
MAX_IDLE_TRANSACTION_TIME=3600
MAX_QUERY_TIME=300
MAX_DEAD_TUPLES_PERCENTAGE=20
MAX_INDEX_BLOAT_PERCENTAGE=30

# Monitoring intervals (in seconds)
RESOURCE_CHECK_INTERVAL=300
CONNECTION_CHECK_INTERVAL=60
REPLICATION_CHECK_INTERVAL=600
VACUUM_CHECK_INTERVAL=3600
BACKUP_CHECK_INTERVAL=86400

# Log file paths
POSTGRESQL_LOG="/var/log/postgresql/postgresql-*.log"
HEALTH_CHECK_LOG="/var/log/postgresql/health-check.log"
RECOVERY_LOG="/var/log/postgresql/recovery.log"

# Database connection settings
DB_HOST="localhost"
DB_PORT="5432"
DB_NAME="rhthotels"
DB_USER="rhtsys_user"
# DB_PASSWORD is set in the environment or .pgpass file

# Monitoring queries
BLOAT_QUERY="SELECT schemaname, tablename, ROUND(CASE WHEN otta=0 THEN 0.0 ELSE sml.relpages/otta::numeric END,1) AS bloat_ratio FROM (SELECT schemaname, tablename, cc.reltuples, cc.relpages, bs, CEIL((cc.reltuples*((datahdr+ma-(CASE WHEN datahdr%ma=0 THEN ma ELSE datahdr%ma END))+nullhdr2+4))/(bs-20::float)) AS otta FROM (SELECT ma,bs,schemaname,tablename, (datawidth+(hdr+ma-(case when hdr%ma=0 THEN ma ELSE hdr%ma END)))::numeric AS datahdr, (maxfracsum*(nullhdr+ma-(case when nullhdr%ma=0 THEN ma ELSE nullhdr%ma END))) AS nullhdr2 FROM (SELECT schemaname, tablename, hdr, ma, bs, SUM((1-null_frac)*avg_width) AS datawidth, MAX(null_frac) AS maxfracsum, hdr+(1+count(*)/8) AS nullhdr FROM pg_stats INNER JOIN pg_class ON pg_class.oid=pg_stats.starelid INNER JOIN pg_namespace ON pg_namespace.oid=pg_class.relnamespace WHERE pg_namespace.nspname NOT IN ('pg_catalog', 'information_schema') GROUP BY 1,2,3,4,5) AS foo) AS rs INNER JOIN pg_class cc ON cc.relname = rs.tablename INNER JOIN pg_namespace nn ON cc.relnamespace = nn.oid AND nn.nspname = rs.schemaname WHERE nn.nspname NOT IN ('pg_catalog', 'information_schema')) AS sml WHERE sml.relpages - otta > 128 ORDER BY bloat_ratio DESC LIMIT 10;"

LONG_RUNNING_QUERY="SELECT pid, now() - pg_stat_activity.query_start AS duration, query FROM pg_stat_activity WHERE state != 'idle' AND now() - pg_stat_activity.query_start > interval '5 minutes' ORDER BY duration DESC;"

IDLE_TRANSACTION_QUERY="SELECT pid, now() - pg_stat_activity.query_start AS duration, query FROM pg_stat_activity WHERE state = 'idle in transaction' AND now() - pg_stat_activity.query_start > interval '30 minutes' ORDER BY duration DESC;"

CONNECTION_COUNT_QUERY="SELECT count(*) as active_connections FROM pg_stat_activity WHERE state != 'idle';"

DEAD_TUPLE_QUERY="SELECT schemaname, relname, n_dead_tup, n_live_tup, (n_dead_tup::float / (n_live_tup + n_dead_tup) * 100)::int AS dead_percentage FROM pg_stat_user_tables WHERE n_live_tup > 0 ORDER BY dead_percentage DESC LIMIT 10;"

# Alert message templates
CPU_ALERT_TEMPLATE="PostgreSQL server CPU usage is at %d%%, which exceeds the threshold of %d%%."
MEMORY_ALERT_TEMPLATE="PostgreSQL server memory usage is at %d%%, which exceeds the threshold of %d%%."
DISK_ALERT_TEMPLATE="PostgreSQL data directory disk usage is at %d%%, which exceeds the threshold of %d%%."
CONNECTION_ALERT_TEMPLATE="PostgreSQL has %d active connections, which is %d%% of the maximum allowed (%d)."
LONG_QUERY_ALERT_TEMPLATE="PostgreSQL has %d queries running for more than %d seconds."
IDLE_TRANSACTION_ALERT_TEMPLATE="PostgreSQL has %d idle transactions running for more than %d seconds."
DEAD_TUPLE_ALERT_TEMPLATE="PostgreSQL table %s.%s has %d%% dead tuples, which exceeds the threshold of %d%%."
BLOAT_ALERT_TEMPLATE="PostgreSQL table %s.%s has a bloat ratio of %d, which exceeds the threshold of %d."
BACKUP_FAILURE_TEMPLATE="PostgreSQL backup failed. Last successful backup was %s ago."
REPLICATION_LAG_TEMPLATE="PostgreSQL replication lag is %d MB, which exceeds the threshold of %d MB."